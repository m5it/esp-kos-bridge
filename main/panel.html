<html>
<head>
<title>Welcome To ESP-KOS-BRIDGE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
label {
	font-weight:bolder;
	padding:3px 5px;
}
label:after {
	clear:both;
	display:block;
}

.clearfix:after {clear: both;content: ".";display: block;font-size: 0;height: 0;line-height: 0;visibility: hidden;}
.clearfix { display: inline-block; }
* html .clearfix { height: 1%; }
.clearfix { display: block; }
</style>
<script>
function qS(s) {return document.querySelector(s);}
function Stringify( cssSelector, opt ) {
	var ret={};
	//var a = document.querySelectorAll("#tm [name]");
	var a = document.querySelectorAll( cssSelector );
	for(var i=0; i<a.length; i++) {
	    var elm = a[i];
	    ret[ elm.name ] = elm.value;
	}
	return JSON.stringify( [ret] );
}
function Fetch( opt ) {
	var href="";
	if( typeof(opt)!='undefined' && typeof(opt['href'])!='undefined' ) {
		href = opt.href;
	}
	else return;
	//
	fetch(href+(href.match(/\?/i)?"&":"?"), {  
	    method :'GET',
	    cache:'no-store',
	    headers:new Headers({'content-type': 'application/json'}), 
    }).then(function (data) {
		return data.json();
	}).then(function(json) {
		console.info("response",json);
		//
		if( typeof(opt)!='undefined' && typeof(opt["onDone"])=='function' ) {
			opt.onDone( json );
		}
		else {
			console.info("Fetch() opt.onDone() not defined!",json);
		}
	}).catch(function(E) {
		console.warn("Fetch() ERROR: ",E);
	});
}
//
function infoLoop() {
	//
	Fetch({href:document.location.origin+"/time/",onDone:function(json) {
		qS("#displayTime>div").innerText = json.data;
	},});
	//
	Fetch({href:document.location.origin+"/free",onDone:function(json) {
		//qS("#displayFree>div").innerText = json.data+" |Â "+json.start_time+" | "+json.restart_time+" | "+json.restart_count;
		qS("#displayFree>div").innerText = json.data;
	},});
	// Repeat loop in 5s
	setTimeout(function() { infoLoop(); },5000);
}
//
window.onload = function() {
	ready();
}
//
function ready() {
	//
	infoLoop();
	// fire once, retrive wifi info
	Fetch({href:document.location.origin+"/wifi",onDone:function(json) {
		console.info("wifi",json);
		qS("#displayAPSSID > input").value = json.ap_ssid;
		qS("#displayAPPWD>input").value    = json.ap_pwd;
		qS("#displaySTASSID>input").value  = json.sta_ssid;
		qS("#displaySTAPWD>input").value   = json.sta_pwd;
	},});
	
	//
	qS("#tm_submit").addEventListener("click",function(e) {
		e.preventDefault();
		
		var q = document.location.origin+"/time/?settm=1"+
		    "&tm_hour="+qS("#tm input[name='tm_hour']").value+
		    "&tm_min="+qS("#tm input[name='tm_min']").value+
		    "&tm_sec="+qS("#tm input[name='tm_sec']").value+
		    //
		    "&tm_year="+qS("#tm input[name='tm_year']").value+
		    "&tm_mday="+qS("#tm input[name='tm_mday']").value+
		    "&tm_mon="+qS("#tm input[name='tm_mon']").value;
		//
		Fetch({href:q,onDone:function(json){
			console.info("timetm response",json);
		},});
		
		e.stopPropagation();
		return false;
	});
	
	//
	qS("input[name='tm_year']").value  = (new Date()).getFullYear();
	qS("input[name='tm_mon']").value   = (new Date()).getMonth();
	qS("input[name='tm_mday']").value  = (new Date()).getDate();
}
</script>
</head>
<body>

<div>
	<div id="displayTime" style="float:left;"><label>Server Time</label><div></div></div>
	<div id="displayFree" style="float:right;"><label>Server Free</label><div></div></div>
	<div class="clearfix"></div>
</div>

<hr>

<div>
	<label>WiFi Informations</label>
	<div>
		<label>AP SSID</label>
		<div id="displayAPSSID"><input name="displayAPSSID" value=""></div>
	</div>
	<div>
		<label>AP PWD</label>
		<div id="displayAPPWD"><input name="displayAPPWD" value=""></div>
	</div>
	<div style="margin:13px;">
		<button id="updateSTA">Update AP</button>
	</div>
	
	<div>
		<label>STA SSID</label>
		<div id="displaySTASSID"><input name="displaySTASSID" value=""></div>
	</div>
	<div>
		<label>STA PWD</label>
		<div id="displaySTAPWD"><input name="displaySTAPWD" value=""></div>
	</div>
	<div style="margin:13px;">
		<button id="updateSTA">Update STA & Restart</button>
	</div>
</div>

<hr>

<div>
	<label>Set Server/Timer Time ( struct tm )</label>
	<div><form id="tm">
		<!-- struct tm -->
		<div><label>TM HOUR</label><input type="text" name="tm_hour" value=""></div>
		<div><label>TM MIN</label><input type="text" name="tm_min" value=""></div>
		<div><label>TM SEC</label><input type="text" name="tm_sec" value=""></div>
		
		<div><label>TM YEAR</label><input type="text" name="tm_year" value=""></div>
		<div><label>TM MDAY</label><input type="text" name="tm_mday" value=""></div>
		<div><label>TM WDAY</label><input type="text" name="tm_wday" value="" disabled=disabled></div>
		<div><label>TM YDAY</label><input type="text" name="tm_yday" value="" disabled=disabled></div>
		<div><label>TM MON</label><input type="text" name="tm_mon" value=""></div>
		<div><label>TM ISDST</label><input type="text" name="tm_isdst" value="" disabled=disabled></div>
	
		<div><button name="submit" id="tm_submit">set</button></div>
	</form></div>
</div>

<hr>
<div>
    <div>
        <div>
			<label>Define gpio</label>
			<div><input type="text" id="" value=""> Define GPIO for 5W Led.</div>
		</div>
        <div>
			<div style="width:50%;float:left;box-sizing:border-box;">
				<label>Start hour</label>
		        <div>
		        </div>
	        </div>
	        <div style="width:50%;float:left;box-sizing:border-box;">
				<label>End hour</label>
		        <div>
		        </div>
	        </div>
	        <div class="clearfix"></div>
        </div>
    </div>
</div>

</body>
</html>
